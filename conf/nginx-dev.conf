#generated by `lor framework`
    # user www www;
pid tmp/dev-nginx.pid;

# This number should be at maxium the number of CPU on the server
worker_processes 1;

events {
    # Number of connections per worker
    worker_connections 4096;
}

http {
    sendfile on;
    include ./mime.types;

    lua_package_path "$prefix/app/?.lua;$prefix/lor/?.lua;$prefix/?.lua;;;;";
    lua_package_cpath "$prefix/app/?.so;$prefix/lor/?.so;$prefix/?.so;;;;";
    #lua_code_cache on;
    lua_code_cache off;
    lua_shared_dict g_cache 512k;
    charset  utf-8;

    log_format main '$request_time # $remote_addr # $remote_user # [$time_local] # '
                      '$request # $status # $body_bytes_sent # '
                      '$http_referer # $http_user_agent # '
                      '$request_length # $upstream_addr # $request_method # '
                      '$uri # $upstream_response_length # $upstream_response_time # $upstream_status';

    server {
        # List port
        listen 8888;

        # Access log
        access_log logs/dev-access.log main;

        # Error log
        error_log logs/dev-error.log debug;

        client_body_buffer_size      4k;
        proxy_buffering off;

        # this variable is for view render（lua-resty-template)
        set $template_root '';


        location /static {
            alias ./app/static; #app/static;
        }

        location = /index.html {
            root ./app/static; #app/static;
        }

        location = /internal {
            internal;
            #set_by_lua $aa 'ngx.log(ngx.ERR, "proxy pass:", ngx.var.request.uri)';
            proxy_pass http://${arg_source_ip_addr}${request_uri};
        }

        # lor runtime
        location / {
            #root ./app/static; #app/static;
            #index index.html;
            if ($uri = "/")
            {
               break; #不会匹配后面的rewrite
            }
            if ($request_uri !~ "^/.*_live/")
            {
                rewrite "(.*)" "/default_live/$1" break;
            }
            content_by_lua_file ./app/main.lua;
        }
    }
}

